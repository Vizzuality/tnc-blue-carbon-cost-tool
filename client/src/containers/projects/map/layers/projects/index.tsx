import { Source, Layer } from "react-map-gl";

import * as d3 from "d3";
import { FeatureCollection, Geometry } from "geojson";
import { FillLayerSpecification } from "mapbox-gl";

import { generateColorRamp } from "@/containers/projects/map/layers/projects/utils";

export default function ProjectsLayer() {
  const _data: FeatureCollection<
    Geometry,
    {
      cost: number;
      abatement: number;
    }
  > = {
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        properties: {
          cost: 10,
          abatement: 10,
        },
        geometry: {
          coordinates: [
            [
              [-1.0188997350152817, 19.339371896125982],
              [-1.0188997350152817, 15.2827299773014],
              [4.790209065497407, 15.2827299773014],
              [4.790209065497407, 19.339371896125982],
              [-1.0188997350152817, 19.339371896125982],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 2,
          abatement: 2,
        },
        geometry: {
          coordinates: [
            [
              [8.553884254294076, 22.347045198308763],
              [8.553884254294076, 18.98034659264529],
              [13.93901438502084, 18.98034659264529],
              [13.93901438502084, 22.347045198308763],
              [8.553884254294076, 22.347045198308763],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 3,
          abatement: 3,
        },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [10.266381087897429, 18.198922150882048],
              [10.126800739719087, 18.192359148568762],
              [9.988595064490216, 18.172734820447474],
              [9.85312422606958, 18.14024251677739],
              [9.721719567720436, 18.095202210312237],
              [9.595669690810766, 18.038057113269076],
              [9.476207106652101, 17.969369007114743],
              [9.364495630484392, 17.889812349055255],
              [9.261618669117883, 17.800167234433463],
              [9.168568533490959, 17.701311307580816],
              [9.086236885294658, 17.594210724810743],
              [9.015406403773625, 17.479910282070346],
              [8.956743735727128, 17.359522826272258],
              [8.910793769403016, 17.23421807359045],
              [8.877975252072886, 17.10521096018074],
              [8.858577752113135, 16.973749651097236],
              [8.85275994973774, 16.84110333187473],
              [8.86054922630853, 16.708549904608123],
              [8.8818425104034, 16.57736370665313],
              [8.916408329433118, 16.448803365550514],
              [8.963890008337529, 16.32409989865731],
              [9.023809951462665, 16.204445160433327],
              [9.095574939782063, 16.090980734512833],
              [9.178482372830471, 15.984787361679347],
              [9.27172738273566, 15.886874988704175],
              [9.374410746275132, 15.79817351671959],
              [9.485547519713867, 15.719524321363023],
              [9.604076320125786, 15.65167261032016],
              [9.728869175858854, 15.595260677076443],
              [9.858741867725827, 15.550822102625256],
              [9.992464681395326, 15.518776949553867],
              [10.128773490365873, 15.49942798532747],
              [10.266381087897429, 15.492957963729829],
              [10.403988685428985, 15.49942798532747],
              [10.540297494399534, 15.518776949553867],
              [10.674020308069032, 15.550822102625256],
              [10.803892999936004, 15.595260677076443],
              [10.928685855669073, 15.65167261032016],
              [11.047214656080993, 15.719524321363023],
              [11.158351429519726, 15.79817351671959],
              [11.261034793059197, 15.886874988704175],
              [11.354279802964387, 15.984787361679347],
              [11.437187236012795, 16.090980734512833],
              [11.508952224332194, 16.204445160433327],
              [11.56887216745733, 16.32409989865731],
              [11.616353846361742, 16.448803365550514],
              [11.65091966539146, 16.57736370665313],
              [11.672212949486328, 16.708549904608123],
              [11.68000222605712, 16.84110333187473],
              [11.674184423681723, 16.973749651097236],
              [11.654786923721971, 17.10521096018074],
              [11.621968406391844, 17.23421807359045],
              [11.576018440067731, 17.359522826272265],
              [11.517355772021233, 17.479910282070346],
              [11.4465252905002, 17.594210724810743],
              [11.364193642303901, 17.701311307580816],
              [11.271143506676976, 17.800167234433463],
              [11.168266545310468, 17.889812349055255],
              [11.056555069142757, 17.969369007114743],
              [10.937092484984092, 18.03805711326907],
              [10.811042608074422, 18.095202210312237],
              [10.679637949725281, 18.14024251677739],
              [10.544167111304644, 18.172734820447474],
              [10.40596143607577, 18.192359148568762],
              [10.266381087897429, 18.198922150882048],
            ],
          ],
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 4,
          abatement: 4,
        },
        geometry: {
          coordinates: [
            [
              [-9.690278800554552, 26.97972035213317],
              [-9.690278800554552, 24.396370522145148],
              [-3.8527118185513416, 24.396370522145148],
              [-3.8527118185513416, 26.97972035213317],
              [-9.690278800554552, 26.97972035213317],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 5,
          abatement: 5,
        },
        geometry: {
          coordinates: [
            [
              [-7.541068855664491, 41.43353951220527],
              [-7.541068855664491, 38.528044523038034],
              [-1.643841285199045, 38.528044523038034],
              [-1.643841285199045, 41.43353951220527],
              [-7.541068855664491, 41.43353951220527],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 6,
          abatement: 6,
        },
        geometry: {
          coordinates: [
            [
              [0.7726470601811286, 48.46965178808685],
              [0.7726470601811286, 45.718470124797705],
              [6.157258642562226, 45.718470124797705],
              [6.157258642562226, 48.46965178808685],
              [0.7726470601811286, 48.46965178808685],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 7,
          abatement: 7,
        },
        geometry: {
          coordinates: [
            [
              [18.520997774407675, 51.43117929808446],
              [18.520997774407675, 47.08565668322254],
              [25.385706207893833, 47.08565668322254],
              [25.385706207893833, 51.43117929808446],
              [18.520997774407675, 51.43117929808446],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 8,
          abatement: 8,
        },
        geometry: {
          coordinates: [
            [
              [35.91663289081157, 51.36524697256908],
              [35.91663289081157, 45.31005648052533],
              [45.92258788209065, 45.31005648052533],
              [45.92258788209065, 51.36524697256908],
              [35.91663289081157, 51.36524697256908],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 9,
          abatement: 9,
        },
        geometry: {
          coordinates: [
            [
              [-6.867226241868707, 54.62702931692684],
              [-6.867226241868707, 51.419015757241226],
              [2.883293358353882, 51.419015757241226],
              [2.883293358353882, 54.62702931692684],
              [-6.867226241868707, 54.62702931692684],
            ],
          ],
          type: "Polygon",
        },
      },
      {
        type: "Feature",
        properties: {
          cost: 10,
          abatement: 0,
        },
        geometry: {
          coordinates: [
            [
              [38.47505991918618, 37.280028551805856],
              [38.47505991918618, 29.10048451439505],
              [50.31049906445517, 29.10048451439505],
              [50.31049906445517, 37.280028551805856],
              [38.47505991918618, 37.280028551805856],
            ],
          ],
          type: "Polygon",
        },
      },
    ],
  };

  const costAbatementSource = {
    id: "cost-abatement-source",
    type: "geojson",
    data: _data,
  };

  const maxCost = d3.max(
    costAbatementSource.data.features,
    (d) => d.properties.cost,
  );
  const maxAbatement = d3.max(
    costAbatementSource.data.features,
    (d) => d.properties.abatement,
  );

  const COLOR_NUMBER = 2;
  const colors = generateColorRamp(COLOR_NUMBER);

  const costAbatementLayer: FillLayerSpecification = {
    id: "cost-abatement-layer",
    type: "fill",
    source: costAbatementSource.id,
    paint: {
      "fill-color": [
        "match",
        [
          "concat",
          [
            "ceil",
            [
              "/",
              ["*", ["/", ["get", "cost"], maxCost], 100],
              100 / COLOR_NUMBER,
            ],
          ],
          [
            "ceil",
            [
              "/",
              ["*", ["/", ["get", "abatement"], maxAbatement], 100],
              100 / COLOR_NUMBER,
            ],
          ],
        ],
        ...colors,
        "#FFF",
      ],
      "fill-opacity": 1,
    },
  };

  return (
    <>
      <Source {...costAbatementSource} />
      <Layer {...costAbatementLayer} />
    </>
  );
}
